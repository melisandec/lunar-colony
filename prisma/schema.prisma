// =============================================================================
// Lunar Colony Tycoon â€” Complete Prisma Schema
// Database: PostgreSQL (Neon.tech free tier)
//
// Design patterns:
//   1. Denormalized computed fields on Player for Frame-speed reads
//   2. Composite indexes for all hot-path queries
//   3. Soft deletes (deletedAt) on player-owned data
//   4. Schema version field on mutable game entities
//   5. Time-partitioned log tables (ProductionLog, TransactionLog)
//   6. GameConfig table for live balance tuning without deploys
//   7. Enums for all fixed sets
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ---------------------------------------------------------------------------
// Enums
// ---------------------------------------------------------------------------

enum ModuleType {
  SOLAR_PANEL
  MINING_RIG
  HABITAT
  RESEARCH_LAB
  WATER_EXTRACTOR
  OXYGEN_GENERATOR
  STORAGE_DEPOT
  LAUNCH_PAD
}

enum ResourceType {
  LUNAR       // Primary currency
  REGOLITH    // Raw building material
  WATER_ICE   // Life-support & fuel
  HELIUM3     // Advanced energy
  RARE_EARTH  // Tech components
}

enum Tier {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

enum TransactionType {
  PRODUCTION
  BUILD
  UPGRADE
  TRADE
  DAILY_REWARD
  ACHIEVEMENT
  ALLIANCE_DIVIDEND
  REFUND
}

enum AchievementCategory {
  BUILDING
  PRODUCTION
  SOCIAL
  EXPLORATION
  MILESTONE
}

enum EventSeverity {
  INFO
  WARNING
  CRITICAL
}

enum AllianceRole {
  LEADER
  OFFICER
  MEMBER
}

enum LeaderboardPeriod {
  DAILY
  WEEKLY
  ALLTIME
}

enum EventStatus {
  PENDING     // Warning period, not yet active
  ACTIVE      // Currently running
  COMPLETED   // Ended, rewards distributed
  CANCELLED   // Aborted early
}

enum EventCategory {
  SCHEDULED   // Cron-triggered recurring events
  RANDOM      // Probability-based on player actions
  TRIGGERED   // Player/alliance milestone triggered
}

// ---------------------------------------------------------------------------
// Player â€” core identity, heavily denormalized for Frame reads
// ---------------------------------------------------------------------------

model Player {
  id              String    @id @default(cuid())
  fid             Int       @unique                    // Farcaster ID
  walletAddress   String?                              // Future Base wallet
  username        String?
  pfpUrl          String?

  // --- Denormalized game state (updated transactionally) ---
  lunarBalance    Decimal   @default(0)  @db.Decimal(20, 4)
  level           Int       @default(1)
  xp              Decimal   @default(0)  @db.Decimal(20, 2)
  lastActive      DateTime  @default(now())
  dailyStreak     Int       @default(0)
  lastDailyAt     DateTime?

  // --- Performance counters (avoid COUNT queries in Frames) ---
  totalEarnings   Decimal   @default(0)  @db.Decimal(20, 4)
  moduleCount     Int       @default(0)
  crewCount       Int       @default(0)
  efficiency      Decimal   @default(100) @db.Decimal(5, 2) // 0-100 %

  // --- Soft delete ---
  deletedAt       DateTime?

  // --- Versioning for optimistic concurrency ---
  version         Int       @default(1)

  // --- Timestamps ---
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // --- Relations ---
  modules             Module[]
  crew                CrewMember[]
  resources           PlayerResource[]
  transactions        Transaction[]
  achievements        PlayerAchievement[]
  productionLogs      ProductionLog[]
  allianceMember      AllianceMember?
  eventParticipants   EventParticipant[]

  // --- Indexes ---
  @@index([fid])
  @@index([level])
  @@index([lunarBalance(sort: Desc)])       // Leaderboard
  @@index([totalEarnings(sort: Desc)])      // Leaderboard
  @@index([lastActive])                     // Stale-player cleanup
  @@index([deletedAt])                      // Soft-delete filter
}

// ---------------------------------------------------------------------------
// Module â€” buildings in a player's colony
// ---------------------------------------------------------------------------

model Module {
  id              String      @id @default(cuid())
  playerId        String
  player          Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)

  // --- Properties ---
  type            ModuleType
  tier            Tier        @default(COMMON)
  level           Int         @default(1)
  efficiency      Decimal     @default(100) @db.Decimal(5, 2)
  coordinates     Json        // { x: number, y: number }

  // --- Production ---
  baseOutput      Decimal     @db.Decimal(10, 4)       // $LUNAR per cycle
  bonusOutput     Decimal     @default(0) @db.Decimal(10, 4)
  lastCollectedAt DateTime    @default(now())
  isActive        Boolean     @default(true)

  // --- Aging / diminishing returns ---
  installedAt     DateTime    @default(now())
  ageInCycles     Int         @default(0)

  // --- Soft delete & versioning ---
  deletedAt       DateTime?
  version         Int         @default(1)

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // --- Indexes ---
  @@index([playerId, isActive])             // "my active modules"
  @@index([playerId, type])                 // "how many rigs do I have?"
  @@index([playerId, deletedAt])            // soft-delete scoped
  @@index([isActive, lastCollectedAt])      // cron tick query
  @@index([installedAt])                    // age-based calculations
  @@index([playerId, isActive, deletedAt])  // hot path: active module lookup
}

// ---------------------------------------------------------------------------
// Crew â€” specialists that boost module output
// ---------------------------------------------------------------------------

model CrewMember {
  id              String    @id @default(cuid())
  playerId        String
  player          Player    @relation(fields: [playerId], references: [id], onDelete: Cascade)

  name            String
  role            String    // engineer, geologist, pilot, scientist, medic
  level           Int       @default(1)
  xp              Decimal   @default(0) @db.Decimal(10, 2)
  specialty       ModuleType?                          // Bonus to this module type

  // --- Stat modifiers (percentage, e.g. 15 = +15 %) ---
  efficiencyBonus Decimal   @default(0) @db.Decimal(5, 2)
  outputBonus     Decimal   @default(0) @db.Decimal(5, 2)

  assignedModuleId String?  // nullable = unassigned
  isActive        Boolean   @default(true)

  deletedAt       DateTime?
  version         Int       @default(1)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([playerId, isActive])
  @@index([playerId, specialty])
  @@index([assignedModuleId])               // crew â†’ module JOIN
  @@index([playerId, isActive, deletedAt])  // hot path: active crew lookup
}

// ---------------------------------------------------------------------------
// PlayerResource â€” per-player balances for every resource type
// ---------------------------------------------------------------------------

model PlayerResource {
  id          String       @id @default(cuid())
  playerId    String
  player      Player       @relation(fields: [playerId], references: [id], onDelete: Cascade)
  type        ResourceType
  amount      Decimal      @default(0) @db.Decimal(20, 4)
  totalMined  Decimal      @default(0) @db.Decimal(20, 4)

  updatedAt   DateTime     @updatedAt

  @@unique([playerId, type])                // One row per resource per player
  @@index([playerId])
}

// ---------------------------------------------------------------------------
// ResourcePrice â€” live market prices for each resource
// ---------------------------------------------------------------------------

model ResourcePrice {
  id              String       @id @default(cuid())
  type            ResourceType @unique
  basePrice       Decimal      @db.Decimal(10, 4)
  currentPrice    Decimal      @db.Decimal(10, 4)
  priceChange24h  Decimal      @default(0) @db.Decimal(8, 4)
  supply          Decimal      @default(0) @db.Decimal(20, 4)
  demand          Decimal      @default(0) @db.Decimal(20, 4)
  lastUpdatedAt   DateTime     @default(now())

  // --- Volatility & bounds ---
  volatility      Decimal      @default(0.05) @db.Decimal(5, 4)  // 0â€“1 scale
  minPrice        Decimal      @db.Decimal(10, 4)                // Floor
  maxPrice        Decimal      @db.Decimal(10, 4)                // Ceiling
  seasonalPhase   Decimal      @default(0) @db.Decimal(6, 4)     // Radians for sin wave

  history         PriceHistory[]

  @@index([type])
}

// ---------------------------------------------------------------------------
// PriceHistory â€” time-series snapshots (last 100 kept per resource)
// ---------------------------------------------------------------------------

model PriceHistory {
  id              String       @id @default(cuid())
  resourcePriceId String
  resourcePrice   ResourcePrice @relation(fields: [resourcePriceId], references: [id], onDelete: Cascade)
  type            ResourceType
  price           Decimal      @db.Decimal(10, 4)
  volume          Decimal      @default(0) @db.Decimal(20, 4)
  supply          Decimal      @default(0) @db.Decimal(20, 4)
  demand          Decimal      @default(0) @db.Decimal(20, 4)
  snapshotAt      DateTime     @default(now())

  @@index([type, snapshotAt(sort: Desc)])
  @@index([resourcePriceId, snapshotAt(sort: Desc)])
}

// ---------------------------------------------------------------------------
// PriceAlert â€” player notifications for significant price movements
// ---------------------------------------------------------------------------

model PriceAlert {
  id              String       @id @default(cuid())
  playerId        String
  resource        ResourceType
  priceAtAlert    Decimal      @db.Decimal(10, 4)
  changePercent   Decimal      @db.Decimal(8, 4)       // e.g. +15.50 or -10.20
  direction       String                                // "up" | "down" | "spike"
  message         String
  isRead          Boolean      @default(false)
  createdAt       DateTime     @default(now())

  @@index([playerId, isRead, createdAt(sort: Desc)])
  @@index([createdAt])                                  // Prune old alerts
}

// ---------------------------------------------------------------------------
// Transaction â€” immutable ledger of all economic events
// ---------------------------------------------------------------------------

model Transaction {
  id          String          @id @default(cuid())
  playerId    String
  player      Player          @relation(fields: [playerId], references: [id], onDelete: Cascade)
  type        TransactionType
  resource    ResourceType    @default(LUNAR)
  amount      Decimal         @db.Decimal(20, 4)       // Positive = credit, negative = debit
  balanceAfter Decimal        @db.Decimal(20, 4)
  description String?
  metadata    Json?                                     // Flexible payload

  createdAt   DateTime        @default(now())

  @@index([playerId, createdAt(sort: Desc)])            // Recent txns
  @@index([playerId, type])
  @@index([type, createdAt])                             // Analytics by type
  @@index([createdAt])                                  // Time-range scans
}

// ---------------------------------------------------------------------------
// Achievement â€” definition table (seeded, not user-created)
// ---------------------------------------------------------------------------

model Achievement {
  id          String              @id @default(cuid())
  key         String              @unique              // e.g. "first_module"
  name        String
  description String
  category    AchievementCategory
  xpReward    Int                 @default(0)
  lunarReward Decimal             @default(0) @db.Decimal(10, 4)
  iconUrl     String?
  threshold   Int                 @default(1)          // e.g. build 10 modules
  sortOrder   Int                 @default(0)

  // --- Relations ---
  players     PlayerAchievement[]

  @@index([category])
}

model PlayerAchievement {
  id            String      @id @default(cuid())
  playerId      String
  player        Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id])
  unlockedAt    DateTime    @default(now())
  progress      Int         @default(0)                 // Partial progress tracking

  @@unique([playerId, achievementId])
  @@index([playerId])
}

// ---------------------------------------------------------------------------
// Alliance â€” player groups for cooperative bonuses
// ---------------------------------------------------------------------------

model Alliance {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  iconUrl     String?
  level       Int       @default(1)
  totalLunar  Decimal   @default(0) @db.Decimal(20, 4)  // Treasury
  memberCount Int       @default(0)
  maxMembers  Int       @default(10)

  deletedAt   DateTime?
  version     Int       @default(1)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  members     AllianceMember[]

  @@index([name])
  @@index([totalLunar(sort: Desc)])                     // Alliance leaderboard
}

model AllianceMember {
  id         String       @id @default(cuid())
  allianceId String
  alliance   Alliance     @relation(fields: [allianceId], references: [id], onDelete: Cascade)
  playerId   String       @unique                      // A player can be in one alliance
  player     Player       @relation(fields: [playerId], references: [id], onDelete: Cascade)
  role       AllianceRole @default(MEMBER)
  joinedAt   DateTime     @default(now())

  @@index([allianceId])
  @@index([playerId])
}

// ---------------------------------------------------------------------------
// ProductionLog â€” time-partitioned daily snapshots (cron-written)
// ---------------------------------------------------------------------------

model ProductionLog {
  id              String       @id @default(cuid())
  playerId        String
  player          Player       @relation(fields: [playerId], references: [id], onDelete: Cascade)
  date            DateTime     @db.Date                 // Partition key
  resource        ResourceType @default(LUNAR)
  totalProduced   Decimal      @default(0) @db.Decimal(20, 4)
  totalCollected  Decimal      @default(0) @db.Decimal(20, 4)
  activeModules   Int          @default(0)
  avgEfficiency   Decimal      @default(0) @db.Decimal(5, 2)

  @@unique([playerId, date, resource])                  // One row per player/day/resource
  @@index([date])                                       // Prune old logs
  @@index([playerId, date(sort: Desc)])                 // Player history
}

// ---------------------------------------------------------------------------
// ActiveEvent â€” live game events (scheduled, random, player-triggered)
// ---------------------------------------------------------------------------

model ActiveEvent {
  id              String        @id @default(cuid())
  type            String                                // e.g. SOLAR_FLARE, PRODUCTION_RUSH
  category        EventCategory
  status          EventStatus   @default(ACTIVE)
  name            String                                // Display name
  description     String
  icon            String        @default("ðŸŽ®")

  // --- Timing ---
  startTime       DateTime
  endTime         DateTime
  warningTime     DateTime?                             // Optional warning before start

  // --- Effect modifiers ---
  modifiers       Json                                  // Record<string, number> â€” e.g. {SOLAR_PANEL_OUTPUT: 2.0}
  mechanics       Json?                                 // Extra rules: {requiresPreparation, emergencyPurchaseAvailable, ...}
  config          Json?                                 // Arbitrary config for this event instance

  // --- Scope ---
  isGlobal        Boolean       @default(true)          // Affects all players vs specific ones
  targetPlayerIds Json?                                 // string[] for non-global events

  // --- Tracking ---
  participantCount Int          @default(0)
  totalRewardsDistributed Decimal @default(0) @db.Decimal(20, 4)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  participants    EventParticipant[]
  rewards         EventReward[]

  @@index([status, startTime])
  @@index([status, endTime])
  @@index([type])
  @@index([category, status])
}

// ---------------------------------------------------------------------------
// EventParticipant â€” tracks player engagement in events
// ---------------------------------------------------------------------------

model EventParticipant {
  id              String      @id @default(cuid())
  eventId         String
  event           ActiveEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  playerId        String
  player          Player      @relation(fields: [playerId], references: [id], onDelete: Cascade)

  // --- Participation data ---
  score           Decimal     @default(0) @db.Decimal(20, 4)   // Event-specific score
  actions         Int         @default(0)                       // Number of qualifying actions
  firstActionAt   DateTime?
  lastActionAt    DateTime?
  metadata        Json?                                         // Event-specific tracking data

  // --- Rewards ---
  rewardClaimed   Boolean     @default(false)
  rewardAmount    Decimal     @default(0) @db.Decimal(20, 4)

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@unique([eventId, playerId])                                 // One entry per player per event
  @@index([playerId, eventId])
  @@index([eventId, score(sort: Desc)])                         // Leaderboard within event
}

// ---------------------------------------------------------------------------
// EventReward â€” distributed rewards archive
// ---------------------------------------------------------------------------

model EventReward {
  id              String      @id @default(cuid())
  eventId         String
  event           ActiveEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  playerId        String
  resource        ResourceType @default(LUNAR)
  amount          Decimal     @db.Decimal(20, 4)
  reason          String                                        // e.g. "Top 10 finisher", "Participation"
  rank            Int?                                          // Placement in event leaderboard

  distributedAt   DateTime    @default(now())

  @@index([eventId])
  @@index([playerId, distributedAt(sort: Desc)])
}

// ---------------------------------------------------------------------------
// GameEvent â€” audit log for significant events
// ---------------------------------------------------------------------------

model GameEvent {
  id          String        @id @default(cuid())
  playerId    String?                                   // Nullable for system events
  type        String                                    // build, collect, upgrade, login, etc.
  severity    EventSeverity @default(INFO)
  data        Json?
  createdAt   DateTime      @default(now())

  @@index([playerId, createdAt(sort: Desc)])
  @@index([type])
  @@index([severity])
  @@index([createdAt])                                  // Time-range cleanup
}

// ---------------------------------------------------------------------------
// LeaderboardSnapshot â€” materialized ranking, rebuilt by cron
// ---------------------------------------------------------------------------

model LeaderboardSnapshot {
  id              String            @id @default(cuid())
  fid             Int
  username        String?
  period          LeaderboardPeriod
  rank            Int
  lunarBalance    Decimal           @db.Decimal(20, 4)
  totalEarnings   Decimal           @db.Decimal(20, 4)
  moduleCount     Int
  level           Int
  efficiency      Decimal           @default(0) @db.Decimal(5, 2)
  snapshotAt      DateTime          @default(now())

  @@unique([fid, period])
  @@index([period, rank])
  @@index([snapshotAt])
}

// ---------------------------------------------------------------------------
// PlayerSummary â€” denormalized snapshot for sub-200ms Frame reads
// Updated by application logic after every state-changing action.
// ---------------------------------------------------------------------------

model PlayerSummary {
  playerId        String   @id                          // FK to Player.id
  fid             Int      @unique
  username        String?
  lunarBalance    Decimal  @default(0)  @db.Decimal(20, 4)
  level           Int      @default(1)
  xp              Decimal  @default(0)  @db.Decimal(20, 2)
  moduleCount     Int      @default(0)
  activeModules   Int      @default(0)
  crewCount       Int      @default(0)
  totalEarnings   Decimal  @default(0)  @db.Decimal(20, 4)
  productionRate  Int      @default(0)                  // Pre-computed per-tick rate
  pendingEarnings Int      @default(0)                  // Estimated pending (stale-okay)
  dailyStreak     Int      @default(0)
  efficiency      Decimal  @default(100) @db.Decimal(5, 2)
  lastCollectedAt DateTime @default(now())
  lastUpdated     DateTime @updatedAt

  @@index([fid])
  @@index([lunarBalance(sort: Desc)])                   // Leaderboard
  @@index([totalEarnings(sort: Desc)])                  // Leaderboard
  @@index([level(sort: Desc)])                          // Leaderboard
}

// ---------------------------------------------------------------------------
// GameConfig â€” live-tunable game balance (no deploys needed)
// ---------------------------------------------------------------------------

model GameConfig {
  id          String   @id @default(cuid())
  key         String   @unique                          // e.g. "tick_interval_ms"
  value       Json                                      // Flexible: number, string, object
  description String?
  category    String   @default("general")              // general, economy, modules, crew
  version     Int      @default(1)
  updatedAt   DateTime @updatedAt
  updatedBy   String?                                   // Admin FID or system

  @@index([category])
}

// ---------------------------------------------------------------------------
// ModuleBlueprint â€” static definitions for module types x tiers
// ---------------------------------------------------------------------------

model ModuleBlueprint {
  id              String     @id @default(cuid())
  type            ModuleType
  tier            Tier
  name            String
  description     String?
  baseOutput      Decimal    @db.Decimal(10, 4)
  baseCost        Decimal    @db.Decimal(10, 4)
  costResource    ResourceType @default(LUNAR)
  upgradeCost     Decimal    @db.Decimal(10, 4)
  maxLevel        Int        @default(10)
  unlockLevel     Int        @default(1)               // Player level required

  // Resource requirements for higher tiers
  requiredResources Json?                               // [{type, amount}]

  iconUrl         String?
  sortOrder       Int        @default(0)
  version         Int        @default(1)
  updatedAt       DateTime   @updatedAt

  @@unique([type, tier])
  @@index([type])
  @@index([unlockLevel])
}
